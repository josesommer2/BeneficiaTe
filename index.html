<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BeneficiaTe – Encuentra tus beneficios</title>
<style>
  :root { --azul:#0d47a1; --azul-2:#0a3a85; --blanco:#fff; --bg:#f6f8fb; --card:#ffffff; --txt:#13233a; --borde:#e5e9f1; --muted:#5b6b81; --ok:#0f766e; }
  * { box-sizing: border-box; }
  html, body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Helvetica Neue", sans-serif; color: var(--txt); background: var(--bg); }
  a { color: inherit; }
  .hero { min-height:60vh; display:grid; place-items:center; background: linear-gradient(180deg, var(--azul) 0%, var(--azul-2) 100%); color:var(--blanco); padding: 24px; }
  .card { width: min(720px, 100%); text-align:center; padding: clamp(20px, 4vw, 36px); border-radius: 16px; background: rgba(255,255,255,0.06); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15); }
  h1 { margin:0 0 12px; font-size: clamp(28px, 6vw, 48px); }
  p { margin: 0 0 14px; line-height: 1.5; }
  .btn { display:inline-block; margin-top: 16px; padding: 12px 22px; border-radius: 10px; background:#fff; color:#0d47a1; text-decoration:none; font-weight:600; box-shadow: 0 6px 22px rgba(0,0,0,.25); }
  header { background: var(--card); border-bottom:1px solid var(--borde); position: sticky; top:0; z-index: 10; }
  .wrap { width: min(1100px, 100%); margin: 0 auto; padding: 16px 20px; }
  .brand { font-weight: 800; color: var(--azul); text-decoration:none; }
  main { display:grid; grid-template-columns: 320px 1fr; gap: 18px; }
  @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
  .panel { background: var(--card); border:1px solid var(--borde); border-radius: 12px; padding: 16px; }
  .panel h2 { margin: 6px 0 12px; font-size: 1.05rem; }
  form label { display:block; font-size: 0.92rem; margin: 8px 0 6px; color: var(--muted); }
  form input, form select { width: 100%; padding: 10px 12px; border:1px solid var(--borde); border-radius:8px; background:#fff; color:var(--txt); font-size: 0.98rem; }
  .fila { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .btns { display:flex; gap:8px; margin-top: 12px; flex-wrap: wrap; }
  button { appearance: none; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor: pointer; }
  .primary { background: var(--azul); color:#fff; }
  .ghost { background: #eef2ff; color: #27306a; }
  .muted { color: var(--muted); }
  .contador { font-size: 0.9rem; color: var(--muted); margin-bottom: 10px; }
  .programa { border-bottom: 1px dashed var(--borde); padding: 14px 4px; }
  .programa:last-child { border-bottom: none; }
  .programa h3 { margin: 0 0 6px; font-size: 1.05rem; }
  .programa p { margin: 0 0 6px; color: #263346; }
  .programa a { color: var(--azul); text-decoration: none; font-weight: 600; }
  .ok { color: var(--ok); font-weight: 700; }
  .privacy { font-size: .88rem; color: var(--muted); margin-top: 8px; }
  .notice { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px 12px; border-radius:10px; }
</style>
</head>
<body>
  <section class="hero" id="home">
    <div class="card">
      <h1>BeneficiaTe</h1>
      <p>Descubre los progrmas sociales y beneficios estatales a los que puedes acceder de manera simple y rápida. Ingresa tu información y ¡Listo!.</p>
      <p style="margin-top: 10px;"><a class="btn" href="#buscar">Comenzar</a></p>
    </div>
  </section>

  <header id="buscar">
    <div class="wrap" style="display:flex; align-items:center; gap:12px;">
      <a class="brand" href="#home">BeneficiaTe</a>
      <span class="muted" style="font-size:.92rem;">Encuentra tus beneficios</span>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button id="descargarHtml" class="ghost" title="Descargar esta página">Descargar HTML</button>
        <button id="descargarCsv" class="ghost" title="Descargar datos embebidos">Descargar CSV</button>
      </div>
    </div>
  </header>

  <div class="wrap" style="margin-top:16px;">
    <main>
      <aside class="panel">
        <h2>Tu perfil</h2>
        <form id="filtros">
          <div class="fila">
            <div>
              <label for="edad">Edad</label>
              <input type="number" id="edad" name="edad" min="0" inputmode="numeric" />
            </div>
            <div>
              <label for="sexo">Sexo</label>
              <select id="sexo" name="sexo">
                <option value="">(cualquiera)</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
              </select>
            </div>
          </div>

          <div>
            <label for="situacion_laboral">Situación laboral</label>
            <select id="situacion_laboral" name="situacion_laboral">
              <option value="">(cualquiera)</option>
              <option value="empleado">Dependiente</option>
              <option value="independiente">Independiente</option>
              <option value="cesante">Cesante</option>
              <option value="estudiante">Estudiante</option>
              <option value="pensionado">Pensionado</option>
            </select>
          </div>

          <div class="fila">
            <div>
              <label for="ingreso">Ingreso líquido (CLP)</label>
              <input type="number" id="ingreso" name="ingreso" min="0" step="1000" inputmode="numeric" />
            </div>
            <div>
              <label for="hijos">Cantidad de hijos</label>
              <input type="number" id="hijos" name="hijos" min="0" inputmode="numeric" />
            </div>
          </div>

          <div>
            <label for="educacion">Nivel educativo</label>
            <select id="educacion" name="educacion">
              <option value="">(cualquiera)</option>
              <option value="basica">Básica / Primaria</option>
              <option value="media">Media / Secundaria</option>
              <option value="tecnica">Técnica</option>
              <option value="superior">Superior</option>
            </select>
          </div>

          <div class="fila">
            <div>
              <label for="region">Región</label>
              <input type="text" id="region" name="region" placeholder="Metropolitana, Valparaíso, ..." />
            </div>
            <div>
              <label for="comuna">Comuna</label>
              <input type="text" id="comuna" name="comuna" placeholder="Providencia, Santiago, ..." />
            </div>
          </div>

          <div class="btns">
            <button type="submit" class="primary">Buscar</button>
            <button type="button" id="limpiar" class="ghost">Limpiar</button>
          </div>
          <p class="privacy">Privacidad: no almacenamos tu información; el cálculo ocurre en tu dispositivo.</p>
        </form>
      </aside>

      <section class="panel" aria-live="polite">
        <div id="estado" class="contador">Cargando datos…</div>
        <div id="resultados"></div>
        <p class="notice" style="margin-top:12px;">
          Tip: Si limpias todos los campos y presionas <strong>Buscar</strong>, verás <span class="ok">todos</span> los programas.
        </p>
      </section>
    </main>
  </div>

  <!-- CSV embebido -->
  <script id="csvData" type="text/plain">id,title,description,ageMin,ageMax,sex,employment,maxIncome,minEducation,minChildren,regions,communes,link
p001,Asignación Familiar,"Asignación para cargas familiares, personas mayores o con discapacidad",,,any,any,, ,1,,"Providencia;Santiago",https://www.ventanillaunicasocial.gob.cl/ficha/83/asignacion-familiar
p002,Asignación Maternal,"Asignación a madres trabajadoras dependientes o independientes durante el embarazo",,,female,empleado;independiente,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/84/asignacion-maternal
p003,Subsidio Familiar (SUF),"Subsidio para familias con menores de edad",,18,any,any,,,1,,,https://www.ventanillaunicasocial.gob.cl/ficha/97/subsidio-familiar
p004,Aporte Familiar Permanente (Bono Marzo),"Bono que se entrega una vez al año a familias vulnerables",,,any,any,,,1,,,https://www.ventanillaunicasocial.gob.cl/ficha/80/aporte-familiar-permanente
p005,Beca Presidente de la República (BPR),"Beca para estudiantes de 1° a 4° medio con buen rendimiento",,,any,estudiante,,secundaria,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/118/beca-presidente-republica
p006,Beca Mantención Educación Superior (BMES),"Beca para mantención de estudiantes de educación superior",18,,any,estudiante,,secundaria,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/111/beca-mantencion-educacion-superior
p007,Subsidio Arriendo,"Subsidio de arriendo para personas que arrendan viviendas",18,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/356/subsidio-arriendo
p008,Subsidio Arriendo Personas Mayores / Discapacidad,"Subsidio de arriendo para personas mayores o con discapacidad",60,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/357/subsidio-arriendo-personas-mayores-personas-discapacidad
p009,Subsidio Clase Media Compra Vivienda (DS1),"Subsidio para compra de vivienda para familias de clase media",18,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/354/subsidio-clase-media-compra-viviendas
p010,Subsidio Mejorar Vivienda,"Programa para ampliar o mejorar la vivienda",18,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/359/subsidio-ampliar-mejorar-vivienda
p011,Programa Habitabilidad Rural,"Subsidio para mejorar viviendas en zonas rurales",18,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/352/habitabilidad-rural
p012,Fondo Solidario Elección Vivienda Compra,"Fondo para elegir vivienda con financiamiento estatal",18,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/349/fondo-solidario-eleccion-vivienda-compra
p013,Proyectos Condominios Vivienda,"Subsidio para condominios habitacionales certificados",18,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/353/proyectos-condominios-vivienda
p014,Subsidio Discapacidad Menores,"Apoyo económico para familias con niños con discapacidad",,18,any,any,,,1,,,https://www.ventanillaunicasocial.gob.cl/ficha/96/subsidio-discapacidad-menores
p015,Pensión Sobrevivencia AFP,"Pensión para sobrevivientes de afiliados al sistema de AFP",,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/94/pension-sobrevivencia-sistema-pensiones
p016,Beca Residencia Indígena Educación Superior (BRI),"Beca para estudiantes indígenas en educación superior",18,,any,estudiante,,secundaria,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/120/beca-residencia-indigena-educacion-superior
p017,Subsidio Leasing Habitacional,"Subsidio para contratos de arriendo con promesa de compraventa (leasing habitacional)",18,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/360/subsidio-contratos-arriendo-promesa-compraventa
p018,Apoyo Personas en Situación de Calle,"Acompañamiento psicosocial y bonos para personas en situación de calle mayores de 18 años",18,,any,any,,,0,,,https://www.ventanillaunicasocial.gob.cl/ficha/acceso/apoyo-situacion-calle
p019,Bono Invierno Personas Mayores,"Bono para adultos mayores en invierno (ejemplo programa)",,,any,any,,,0,,,
p020,Pensión Básica Solidaria Vejez (PBSV),"Pensión para personas mayores de bajos recursos",65,,any,any,,,0,,,
</script>

  <script>
    // Parser CSV con soporte de comillas
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i]; const next = text[i+1];
        if (inQuotes) {
          if (c === '"' && next === '"') { cur += '"'; i++; }
          else if (c === '"') { inQuotes = false; }
          else { cur += c; }
        } else {
          if (c === '"') { inQuotes = true; }
          else if (c === ',') { row.push(cur); cur=''; }
          else if (c === '\n') { row.push(cur); rows.push(row); row=[]; cur=''; }
          else if (c === '\r') { /* skip */ }
          else { cur += c; }
        }
      }
      if (cur.length>0 || inQuotes || row.length) { row.push(cur); rows.push(row); }
      if (!rows.length) return [];
      const headers = rows[0].map(h => h.trim());
      return rows.slice(1).filter(r => r.some(c => String(c).trim() !== '')).map(r => {
        const obj = {}; headers.forEach((h,i)=> obj[h] = (r[i] ?? '').trim()); return obj;
      });
    }

    // Utils
    const norm = (s) => (s??'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
    const toNum = (v) => { if (v===null||v===undefined||v==='') return null; const n = Number(String(v).replace(/\./g,'').replace(',','.')); return Number.isFinite(n)?n:null; };

    function leerFiltros(formId='filtros') {
      const f = document.getElementById(formId);
      const get = (name) => f?.elements?.[name]?.value ?? '';
      const n = (v) => { const t=String(v??'').trim(); if(!t) return null; const val=Number(t.replace(/\./g,'').replace(',','.')); return Number.isFinite(val)?val:null; };
      return {
        edad: n(get('edad')),
        sexo: get('sexo'),
        situacionLaboral: get('situacion_laboral'),
        ingresoLiquido: n(get('ingreso')),
        hijos: n(get('hijos')),
        nivelEducativo: get('educacion'),
        region: get('region'),
        comuna: get('comuna'),
      };
    }

    function filtrosVacios(f){
      return (f.edad==null||f.edad==='') && !f.sexo && !f.situacionLaboral && (f.ingresoLiquido==null||f.ingresoLiquido==='') && (f.hijos==null||f.hijos==='') && !f.nivelEducativo && !f.region && !f.comuna;
    }

    function rankEdu(e){
      const m = { basica:1, basica_:1, primaria:1, media:2, secundaria:2, tecnica:3, tecnico:3, superior:4, universitaria:4 };
      return m[e] ?? m[e?.replace(/\s+/g,'')] ?? 0;
    }

    function coincide(p, filtros){
      const {edad, sexo, situacionLaboral, ingresoLiquido, hijos, nivelEducativo, region, comuna} = filtros;
      const sexoU = norm(sexo);
      const sitU  = norm(situacionLaboral);
      const eduU  = norm(nivelEducativo);
      const regionU = norm(region);
      const comunaU = norm(comuna);

      const minAge = toNum(p.ageMin); const maxAge = toNum(p.ageMax);
      const pSexo = norm(p.sex); // 'any'|'male'|'female'
      const pEmpl = norm(p.employment||'').split(';').map(norm).filter(Boolean); // ej: 'empleado;independiente'
      const pMaxIncome = toNum(p.maxIncome);
      const pMinEdu = norm(p.minEducation);
      const pMinKids = toNum(p.minChildren);
      const pRegs = norm(p.regions||'');
      const pComs = norm(p.communes||'');
      const regs = pRegs ? pRegs.split(';').map(norm).filter(Boolean) : ['todas'];
      const coms = pComs ? pComs.split(';').map(norm).filter(Boolean) : ['todas'];

      const dentroRango = (val, min, max) => { if (val==null) return true; if (min!=null && val<min) return false; if (max!=null && val>max) return false; return true; };

      const cumpleSexo = () => {
        if (!sexoU) return true; // sin filtro
        if (pSexo==='any' || !pSexo) return true;
        const mapa = { m:'male', masculino:'male', f:'female', femenino:'female' };
        const user = mapa[sexoU] ?? sexoU;
        return pSexo === user;
      };

      const cumpleSituacion = () => {
        if (!sitU) return true;
        if (!pEmpl.length || pEmpl.includes('any')) return true;
        // equivalencias: dependiente=empleado
        const equiv = { dependiente:'empleado', empleado:'empleado' };
        const u = equiv[sitU] ?? sitU;
        return pEmpl.includes(u);
      };

      const cumpleEduc = () => {
        if (!eduU) return true;
        const req = rankEdu(pMinEdu); const usr = rankEdu(eduU);
        if (req===0) return true; return usr >= req;
      };

      const cumpleIngreso = () => {
        if (ingresoLiquido==null) return true; if (pMaxIncome==null) return true; return ingresoLiquido <= pMaxIncome;
      };

      const cumpleHijos = () => {
        if (hijos==null) return true; if (pMinKids==null) return true; return hijos >= pMinKids;
      };

      const cumpleRegion = () => { if (!regionU) return true; if (regs.includes('todas')) return true; return regs.includes(regionU); };
      const cumpleComuna = () => { if (!comunaU) return true; if (coms.includes('todas')) return true; return coms.includes(comunaU); };

      return dentroRango(edad, minAge, maxAge) && cumpleSexo() && cumpleSituacion() && cumpleIngreso() && cumpleHijos() && cumpleEduc() && cumpleRegion() && cumpleComuna();
    }

    function renderResultados(lista){
      const el = document.getElementById('resultados');
      const estadoEl = document.getElementById('estado');
      if (!Array.isArray(lista) || !lista.length){
        el.innerHTML = `<p>No se encontraron programas que coincidan con tu perfil.</p>`;
        if (estadoEl) estadoEl.textContent = '0 programas';
        return;
      }
      if (estadoEl) estadoEl.innerHTML = `<strong>${lista.length}</strong> programa(s) encontrado(s)`;
      el.innerHTML = lista.map(p=>`
        <div class="programa">
          <h3>${p.title || p.nombre || 'Programa'}</h3>
          ${p.description? `<p>${p.description}</p>`: ''}
          ${p.link? `<p><a href="${p.link}" target="_blank" rel="noopener">Ver más</a></p>`: ''}
        </div>
      `).join('');
    }

    let PROGRAMAS = [];

    function descargar(nombre, contenido, tipo='text/plain'){
      const blob = new Blob([contenido], {type: tipo});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = nombre; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function init(){
      // Cargar CSV embebido
      const raw = document.getElementById('csvData').textContent.trim();
      PROGRAMAS = parseCSV(raw);
      const estadoEl = document.getElementById('estado');
      if (!PROGRAMAS.length){ estadoEl.textContent = 'No se pudo cargar el CSV embebido.'; }
      else { renderResultados(PROGRAMAS); }

      const form = document.getElementById('filtros');
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const f = leerFiltros();
        if ((f.edad==null||f.edad==='') && !f.sexo && !f.situacionLaboral && (f.ingresoLiquido==null||f.ingresoLiquido==='') && (f.hijos==null||f.hijos==='') && !f.nivelEducativo && !f.region && !f.comuna){
          renderResultados(PROGRAMAS); return;
        }
        const filtrados = PROGRAMAS.filter(p=>coincide(p,f));
        renderResultados(filtrados);
      });

      document.getElementById('limpiar').addEventListener('click', ()=>{ form.reset(); if (PROGRAMAS.length) renderResultados(PROGRAMAS); });

      document.getElementById('descargarHtml').addEventListener('click', ()=>{
        descargar('beneficiate-embebido.html', document.documentElement.outerHTML, 'text/html;charset=utf-8');
      });
      document.getElementById('descargarCsv').addEventListener('click', ()=>{
        descargar('Datos2.csv', raw, 'text/csv;charset=utf-8');
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
